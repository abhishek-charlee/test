name: Feature branch deployment Workflow

on:
  push:
    branches:
      - "feat/*/*"
      - "Feat/*/*"
      - "chore/*/*"
      - "Chore/*/*"

env:
  environment: github.ref_name.split

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ environment }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Extract Project and Ticket ID
        run: |
          echo $ENVV
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          IFS='/' read -ra PARTS <<< "$BRANCH_NAME"
          project_name=${PARTS[1]}
          ticket_id=${PARTS[2]}
          echo "PROJECT_NAME=$project_name" >> $GITHUB_ENV
          echo "TICKET_ID=$ticket_id" >> $GITHUB_ENV
        env:
          ENVV: env.environment

      - name: Display Project and Ticket ID
        run: |
          echo "Project Name: $PROJECT_NAME"
          echo "Ticket ID: $TICKET_ID"

      - name: ssh proxy command
        uses: appleboy/ssh-action@master
        with:
          host: 10.0.1.6
          username: $PROJECT_NAME
          key: ${{ secrets[env.SECRET_NAME] }}
          port: 8463
          proxy_host: 34.138.106.113
          proxy_username: abhishek
          proxy_key: ${{ secrets.SSH_PRIVATE_KEY }}
          proxy_port: 22
          script: |
            whoami
            # sudo su - test3 -c id
            # sudo su - test3 -c pwd
            # sudo su - test3 -c "mkdir UI/$TICKET_ID"
            # sudo su - test3 -c "cd UI/$TICKET_ID"
            # sudo su - test3 -c "ls UI/"
            # sudo su - test3 -c "cd UI/$TICKET_ID && git clone git@github.com:abhishek-charlee/test.git"

            # start_port=3000
            # end_port=9000

            # for ((port=start_port; port<=end_port; port++))
            # do
            #   if ! lsof -i :$port &> /dev/null; then
            #     echo "Port $port is available."
            #     export AVAILABLE_PORT=$port
            #     break  # Exit the loop after finding an available port
            #   fi
            # done
        env:
          SECRET_NAME: ${{ secrets[ ${{ env.PROJECT_SECRET_KEY }}_PRIVATE_KEY ]  }}
      # - name: Start Server
      #   run: |
      #     cd your_project_directory
      #     ./start_server.sh $AVAILABLE_PORT
