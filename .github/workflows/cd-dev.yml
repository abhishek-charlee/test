name: QA deployment
#
on:
  push:

jobs:
  verify-deployment-commit:
    runs-on: ubuntu-latest
    if: ${{ contains(github.event.head_commit.message, 'please deploy') }}
    steps:
      - name: ðŸ” Verify Deployment commit
        run: echo "The commit message contains a deployment request, hence deploying to respective environment ... "

  deploy-to-qa:
    runs-on: ubuntu-latest
    environment: qa-nlc
    needs: verify-deployment-commit
    steps:
      - name: ðŸ“¦ Checkout Code
        uses: actions/checkout@v3

      - name: ðŸŽ« Extract Ticket ID
        run: |
          branch_name="${GITHUB_REF##refs/heads/}"
          echo "BRANCH_NAME=$branch_name" >> $GITHUB_ENV
          if [[ $branch_name =~ ([-_]?)([0-9]+[-_]?[^0-9]*)$ ]]; then
            ticket_id="${BASH_REMATCH[2]}"
            echo "Ticket ID: $ticket_id"
            echo "TICKET_ID=$ticket_id" >> $GITHUB_ENV
          else
            echo "No valid ticket ID found in the branch name."
          fi

      - name: ðŸŽ« Extract Port Number
        run: |
          PORT_NUMBER=$(echo "${{ github.event.head_commit.message }}" | grep -oP 'please deploy to port \K\d+')
          echo  Port Number: ${{ env.PORT_NUMBER }}
          echo "PORT_NUMBER=${PORT_NUMBER}" >> $GITHUB_ENV

      - name: Set DEPLOYMENT_LOCATION # used for the slack notification script
        run: |
          echo "DEPLOYMENT_LOCATION=/home2/qa-nlc/UI/${{ env.TICKET_ID }}/smartC_UI" >> $GITHUB_ENV

      - name: ðŸ”” Notify pre-deployment status
        if: always() && true
        run: ./scripts/notify.sh -s 'in_progress' -w ${{ secrets.SLACK_WEBHOOK }} -t ${{ env.TICKET_ID }} -b ${{ env.BRANCH_NAME }} -d ${{ env.DEPLOYMENT_LOCATION }}

      - name: ðŸš€ Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TARGET_HOST }}
          username: ${{ secrets.TARGET_USERNAME }}
          key: ${{ secrets.TARGET_PRIVATE_KEY }}
          port: ${{ secrets.TARGET_PORT }}
          proxy_host: ${{ secrets.PROXY_HOST }}
          proxy_username: ${{ secrets.PROXY_USERNAME }}
          proxy_key: ${{ secrets.PROXY_PRIVATE_KEY }}
          proxy_port: ${{ secrets.PROXY_HOST_PORT }}
          script: |
            echo "SSHing into the VM..."
            cd UI

            existing_pid=$(lsof -t -i:${{ env.PORT_NUMBER }} || true)
            if [ -n "$existing_pid" ]; then
              echo "Killing existing process on port ${{ env.PORT_NUMBER }}..."
            fi

            if [ -d ${{ env.TICKET_ID }} ]; then
                echo "Directory exists."
                cd ${{ env.TICKET_ID }}/smartC_UI
                git stash
                git pull
                echo "$(pwd)"
            else
                echo "Directory does not exist."
                mkdir ${{ env.TICKET_ID }}
                cd ${{ env.TICKET_ID }}
                git clone git@github.com:infinilytics/smartC_UI.git -b ${{ env.BRANCH_NAME }}
                echo $(pwd)
            fi

      - name: ðŸ”” Notify post-deployment status
        if: always() && true
        run: ./scripts/notify.sh -s ${{ job.status }} -w ${{ secrets.SLACK_WEBHOOK }} -t ${{ env.TICKET_ID }} -b ${{ env.BRANCH_NAME }} -d ${{ env.DEPLOYMENT_LOCATION }}
